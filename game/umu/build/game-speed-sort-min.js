function shuffle(a){for(var b,c,d=a.length;d;b=Math.floor(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}function ajax(a,b,c,d){var e=new XMLHttpRequest;e.overrideMimeType&&e.overrideMimeType("application/json"),e.open(a,b,!0),e.ontimeout=d,e.onreadystatechange=function(){4===e.readyState&&(200===e.status||0===e.status&&e.responseText?null!=c&&c(e.responseText):null!=d&&d())},e.send(null)}function deserializeGameInfo(a){var b={};return void 0===a||null===a||""==a?b:(a.split(",").map(function(a){if(void 0!==a){var c=a.split(":");void 0!==c[0]&&void 0!==c[1]&&(b[c[0]]=c[1])}}),b)}function serializeGameInfo(a){return Object.keys(a).map(function(b){return b+":"+a[b]}).join(",")}function erfc(a){var b=Math.abs(a),c=1/(1+b/2),d=c*Math.exp(-b*b-1.26551223+c*(1.00002368+c*(.37409196+c*(.09678418+c*(-.18628806+c*(.27886807+c*(-1.13520398+c*(1.48851587+c*(-.82215223+.17087277*c)))))))));return a>=0?d:2-d}function ierfc(a){if(a>=2)return-100;if(0>=a)return 100;for(var b=1>a?a:2-a,c=Math.sqrt(-2*Math.log(b/2)),d=-.70711*((2.30753+.27061*c)/(1+c*(.99229+.04481*c))-c),e=0;2>e;e++){var f=erfc(d)-b;d+=f/(1.1283791670955126*Math.exp(-(d*d))-d*f)}return 1>a?d:-d}function fromPrecisionMean(a,b){return gaussian(b/a,1/a)}var game={data:{score:0,hitScore:10,maxScore:3e3,totalRank:1e4,level:1,combo:0,totalTime:45,curTime:0,startTime:0,screenWidth:640,screenHeight:960,spriteSize:192,margin:0,playerId:Math.floor(1e5*Math.random()),apiUrl:"http://pd.iuv.net/game.php"},onload:function(){return me.video.init("screen",me.video.CANVAS,game.data.screenWidth,game.data.screenHeight,!0,"auto")?(me.state.set(me.state.LOADING,new game.LoadingScene),me.state.set(me.state.PLAY,new game.PlayScene),me.state.set(me.state.GAMEOVER,new game.GameOverScene),void me.loader.load({name:"logo",type:"image",src:"data/img/Logo.png"},this.onLogoLoaded.bind(this))):void alert("Your browser does not support HTML5 canvas.")},onLogoLoaded:function(){me.loader.preload(game.resources),me.loader.onload=this.loaded,me.state.change(me.state.LOADING)},loaded:function(){me.state.change(me.state.PLAY)}};game.resources=[{name:"logo",type:"image",src:"data/img/Logo.png"},{name:"left",type:"image",src:"data/img/Left.png"},{name:"right",type:"image",src:"data/img/Right.png"},{name:"correct",type:"image",src:"data/img/Correct.png"},{name:"miss",type:"image",src:"data/img/Miss.png"},{name:"quit",type:"image",src:"data/img/Quit.png"},{name:"retry",type:"image",src:"data/img/Retry.png"},{name:"button",type:"image",src:"data/img/speed_sort/button.png"},{name:"background",type:"image",src:"data/img/speed_sort/back.png"},{name:"frame",type:"image",src:"data/img/matching_pair/mp_highlighted.png"},{name:"fruit-1",type:"image",src:"data/img/speed_sort/0.png"},{name:"fruit-2",type:"image",src:"data/img/speed_sort/1.png"},{name:"fruit-3",type:"image",src:"data/img/speed_sort/2.png"},{name:"fruit-4",type:"image",src:"data/img/speed_sort/3.png"},{name:"food-1",type:"image",src:"data/img/speed_sort/4.png"},{name:"food-2",type:"image",src:"data/img/speed_sort/5.png"},{name:"food-3",type:"image",src:"data/img/speed_sort/6.png"},{name:"food-4",type:"image",src:"data/img/speed_sort/7.png"},{name:"number-1",type:"image",src:"data/img/matching_pair/mp_num_1.png"},{name:"number-2",type:"image",src:"data/img/matching_pair/mp_num_2.png"},{name:"number-3",type:"image",src:"data/img/matching_pair/mp_num_3.png"},{name:"number-4",type:"image",src:"data/img/matching_pair/mp_num_4.png"},{name:"number-5",type:"image",src:"data/img/matching_pair/mp_num_5.png"},{name:"number-6",type:"image",src:"data/img/matching_pair/mp_num_6.png"},{name:"number-7",type:"image",src:"data/img/matching_pair/mp_num_7.png"},{name:"number-8",type:"image",src:"data/img/matching_pair/mp_num_8.png"},{name:"number-9",type:"image",src:"data/img/matching_pair/mp_num_9.png"},{name:"icon-1",type:"image",src:"data/img/matching_pair/mp_shape_0.png"},{name:"icon-2",type:"image",src:"data/img/matching_pair/mp_shape_1.png"},{name:"icon-3",type:"image",src:"data/img/matching_pair/mp_shape_2.png"},{name:"icon-4",type:"image",src:"data/img/matching_pair/mp_shape_3.png"},{name:"icon-5",type:"image",src:"data/img/matching_pair/mp_shape_4.png"},{name:"icon-6",type:"image",src:"data/img/matching_pair/mp_shape_5.png"},{name:"icon-7",type:"image",src:"data/img/matching_pair/mp_shape_6.png"},{name:"icon-8",type:"image",src:"data/img/matching_pair/mp_shape_7.png"},{name:"icon-9",type:"image",src:"data/img/matching_pair/mp_shape_8.png"},{name:"icon-10",type:"image",src:"data/img/matching_pair/mp_shape_9.png"},{name:"icon-11",type:"image",src:"data/img/matching_pair/mp_shape_10.png"},{name:"icon-12",type:"image",src:"data/img/matching_pair/mp_shape_11.png"},{name:"icon-13",type:"image",src:"data/img/matching_pair/mp_shape_12.png"},{name:"icon-14",type:"image",src:"data/img/matching_pair/mp_shape_13.png"},{name:"icon-15",type:"image",src:"data/img/matching_pair/mp_shape_14.png"},{name:"icon-16",type:"image",src:"data/img/matching_pair/mp_shape_15.png"},{name:"icon-17",type:"image",src:"data/img/matching_pair/mp_shape_16.png"},{name:"icon-18",type:"image",src:"data/img/matching_pair/mp_shape_17.png"},{name:"icon-19",type:"image",src:"data/img/matching_pair/mp_shape_18.png"},{name:"icon-20",type:"image",src:"data/img/matching_pair/mp_shape_19.png"},{name:"32x32_font",type:"image",src:"data/img/32x32_font.png"}];var QueryString=function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if("undefined"==typeof a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}(),Gaussian=function(a,b){if(0>=b)throw new Error("Variance must be > 0 (but was "+b+")");this.mean=a,this.variance=b,this.standardDeviation=Math.sqrt(b)};Gaussian.prototype.pdf=function(a){var b=this.standardDeviation*Math.sqrt(2*Math.PI),c=Math.exp(-Math.pow(a-this.mean,2)/(2*this.variance));return c/b},Gaussian.prototype.cdf=function(a){return.5*erfc(-(a-this.mean)/(this.standardDeviation*Math.sqrt(2)))},Gaussian.prototype.add=function(a){return gaussian(this.mean+a.mean,this.variance+a.variance)},Gaussian.prototype.sub=function(a){return gaussian(this.mean-a.mean,this.variance+a.variance)},Gaussian.prototype.scale=function(a){return gaussian(this.mean*a,this.variance*a*a)},Gaussian.prototype.mul=function(a){if("number"==typeof a)return this.scale(a);var b=1/this.variance,c=1/a.variance;return fromPrecisionMean(b+c,b*this.mean+c*a.mean)},Gaussian.prototype.div=function(a){if("number"==typeof a)return this.scale(1/a);var b=1/this.variance,c=1/a.variance;return fromPrecisionMean(b-c,b*this.mean-c*a.mean)},Gaussian.prototype.ppf=function(a){return this.mean-this.standardDeviation*Math.sqrt(2)*ierfc(2*a)};var UIButton=me.Sprite.extend({init:function(a,b,c){c=c||{},me.Sprite.prototype.init.apply(this,[a,b,me.loader.getImage(c.imageName),c.width||256,c.height||256]),this.scaleFlag=!0,this.touchStartTween=new me.Tween(this.scale),this.touchEndTween=new me.Tween(this.scale),this.onclick=c.onclick,this.alwaysUpdate=!0,me.input.registerPointerEvent("pointerdown",this,this.onPointerDown.bind(this)),me.input.registerPointerEvent("pointerup",this,this.onPointerUp.bind(this))},update:function(){return!0},onPointerDown:function(){var a=this;this.touchEndTween.stop(),this.touchStartTween.to({x:.75,y:.75},100).onComplete(function(){a.resize(1,1),a.scaleFlag=!0}).start()},onPointerUp:function(){var a=this;this.touchStartTween.stop(),this.touchEndTween.to({x:1,y:1},100).onComplete(function(){a.resize(1,1),a.scaleFlag=!0}).start(),null!=this.onclick&&this.onclick()},onDestroyEvent:function(){me.input.releasePointerEvent("pointerdown",this),me.input.releasePointerEvent("pointerup",this)}}),UILabel=me.Renderable.extend({init:function(a,b,c){this.settings=c||{},this._super(me.Renderable,"init",[a,b,10,10]),1==this.settings.bitmapFont?(this.font=new me.BitmapFont(this.settings.font||"32x32_font",this.settings.size||32,this.settings.scale||null,this.settings.firstChar||null),this.font.set(this.settings.textAlign||"left")):this.font=new me.Font(this.settings.font||"Arial",this.settings.size||32,this.settings.fillStyle||"black",this.settings.textAlign||"left"),this.floating=!0,this.text=this.settings.text||"NEW LABEL"},draw:function(a){if(1==this.settings.bitmapFont)this.font.draw(a,this.text,this.pos.x,this.pos.y);else{var b=a.getContext();this.font.measureText(b,this.text),this.font.draw(b,this.text,this.pos.x,this.pos.y)}}}),Fruit=me.Sprite.extend({init:function(a,b,c,d){me.Sprite.prototype.init.apply(this,[b,c,me.loader.getImage(a),d,d]),this.imageName=a,this.resize(.05,.05),this.targetScale=1,this.isScaling=!1},update:function(){return!0},open:function(){{var a=this;new me.Tween(this.scale).to({x:a.targetScale,y:a.targetScale},200).onComplete(function(){a.resize(a.targetScale,a.targetScale),a.scaleFlag=!0,a.isScaling=!1}).start()}},move:function(a){new me.Tween(this.pos).to({x:a.pos.x,y:a.pos.y},200).easing(me.Tween.Easing.Linear.None).start()},close:function(){new me.Tween(this).to({alpha:0},200).easing(me.Tween.Easing.Linear.None).start()}}),Arrow=UIButton.extend({init:function(a,b,c,d,e,f,g){this._super(UIButton,"init",[c,d,{imageName:"button",onclick:g,width:e,height:f}]),this.xScale=1,"right"==a&&(this.flipX(!0),this.xScale=-1),this.legendSprite=b},onPointerDown:function(){var a=this;this.touchEndTween.stop(),this.touchStartTween.to({x:.75*a.xScale,y:.75},100).onComplete(function(){a.resize(1*a.xScale,1),a.scaleFlag=!0}).start()},onPointerUp:function(){var a=this;this.touchStartTween.stop(),this.touchEndTween.to({x:1*a.xScale,y:1},100).onComplete(function(){a.resize(1*a.xScale,1),a.scaleFlag=!0}).start(),null!=this.onclick&&this.onclick(a.legendSprite)}}),Mark=me.Sprite.extend({init:function(a,b,c){me.Sprite.prototype.init.apply(this,[b,c,me.loader.getImage(a),256,256]),this.alpha=0,this.imageName=a,this.fadeIn=new me.Tween(this),this.fadeOut=new me.Tween(this),this.fadeIn.to({alpha:1},200).chain(this.fadeOut.to({alpha:0},400)).start(),this.alwaysUpdate=!0},update:function(){return!0}}),Retry=UIButton.extend({init:function(){this._super(UIButton,"init",[game.data.screenWidth/4*3-128,game.data.screenHeight/2+128,{imageName:"retry",onclick:function(){me.state.change(me.state.PLAY)}}])}}),ReturnToIndex=UIButton.extend({init:function(){this._super(UIButton,"init",[game.data.screenWidth/4-128-5,game.data.screenHeight/2+128,{imageName:"quit",onclick:function(){window.location.href="./index.html"}}])}}),Upload=UIButton.extend({init:function(a,b){this._super(UIButton,"init",[game.data.screenWidth/4*3-128,game.data.screenHeight/2-128,{imageName:"correct",onclick:function(){ajax("GET",game.data.apiUrl+"?m=post&game_id="+game.data.gameId+"&user_id="+game.data.playerId+"&score="+game.data.score,a,b)}}])}});game.hud=game.hud||{},game.hud.Container=me.Container.extend({init:function(){this._super(me.Container,"init"),this.isPersistent=!0,this.z=1/0,this.name="hud",this.addChild(new game.hud.Score(0,0)),this.addChild(new game.hud.Time(0,50)),this.addChild(new game.hud.Combo(0,100))}}),game.hud.Score=UILabel.extend({init:function(a,b){this._super(UILabel,"init",[a,b,{bitmapFont:!0}])},update:function(){return this.text="SCORE: "+game.data.score,!1}}),game.hud.Time=UILabel.extend({init:function(a,b){this._super(UILabel,"init",[a,b,{bitmapFont:!0}])},update:function(){var a=me.timer.getTime()-game.data.startTime;return game.data.curTime>0&&(game.data.curTime=game.data.totalTime-~~(a/1e3)),game.data.curTime<0&&(game.data.curTime=0),0==game.data.curTime&&(console.log("GameOver"),me.state.change(me.state.GAMEOVER)),this.text="TIME: "+game.data.curTime,!0}}),game.hud.Combo=UILabel.extend({init:function(a,b){this._super(UILabel,"init",[a,b,{bitmapFont:!0}])},update:function(){return this.text=game.data.combo>0?game.data.combo+" COMBO":"",!1}}),game.data.gameId=1002;var imgSize=220,Round=me.Container.extend({init:function(){this.elems=["fruit-1","fruit-2","fruit-3","fruit-4","food-1","food-2","food-3","food-4"],this.count=this.countInit,this.countArray=[4,5,6,7,8,9],this._super(me.Container,"init"),this._init()},_init:function(){this.alpha=0,this.count=game.data.level<this.countArray.length?this.countArray[game.data.level-1]:this.countArray[this.countArray.length-1],this.leftId=Math.floor(Math.random()*this.elems.length),this.rightId=Math.floor(Math.random()*this.elems.length),this.leftId==this.rightId&&(this.leftId=(this.leftId+1)%this.elems.length),this.leftSprite=new Fruit(this.elems[this.leftId],0,game.data.screenHeight-2*imgSize),this.rightSprite=new Fruit(this.elems[this.rightId],game.data.screenWidth-imgSize,game.data.screenHeight-2*imgSize),this.leftSprite.open(),this.rightSprite.open(),this.addChild(this.leftSprite,20),this.addChild(this.rightSprite,20);var a=this;this.leftArrow=new Arrow("left",this.leftSprite,0,game.data.screenHeight-imgSize,imgSize,imgSize,function(b){a.ready&&(a.curObj.imageName==b.imageName?a._onCorrect(b):a._onMiss())}),this.rightArrow=new Arrow("right",this.rightSprite,game.data.screenWidth-imgSize,game.data.screenHeight-imgSize,imgSize,imgSize,function(b){a.ready&&(a.curObj.imageName==b.imageName?a._onCorrect(b):a._onMiss())}),this.addChild(this.leftArrow),this.addChild(this.rightArrow),this.headX=game.data.screenWidth/2-imgSize/2,this.headY=game.data.screenHeight-2*imgSize,this.objList=[];for(var b=0;b<this.count;b++){var c=this._spawn(b);this.objList.push(c)}this.curObj=this.objList.shift(),this.ready=!0},_onCorrect:function(a){var b=this.curObj;b.move(a),b.close(),game.data.score+=game.data.hitScore;{var c=this;(new me.Tween).delay(400).onComplete(function(){c.removeChild(b)}).start()}if(this.objList.length>0){this.curObj=this.objList.shift(),this.curObj.move(b);for(var d=this.curObj,e=0;e<this.objList.length;e++)this.objList[e].move(d),d=this.objList[e]}else this._onClear()},_onMiss:function(){game.data.combo=0,game.data.level--,game.data.level<1&&(game.data.level=1);var a=new Mark("miss",game.data.screenWidth/2-imgSize/2,game.data.screenHeight/2-imgSize/2);this.addChild(a,30);var b=this;this.finish(!1,function(){b.restart()})},_onClear:function(){game.data.score+=(game.data.level+2*game.data.combo)*game.data.hitScore,game.data.level++,game.data.combo++;var a=new Mark("correct",game.data.screenWidth/2-imgSize/2,game.data.screenHeight/2-imgSize/2);this.addChild(a,30);var b=this;this.finish(!0,function(){b.restart()})},finish:function(a,b){this.ready=!1;new me.Tween(this).delay(800).to({alpha:0},400).onComplete(function(){null!=b&&b()}).start()},_spawn:function(a){var b=this.leftId;Math.random()>.5&&(b=this.rightId);var c=new Fruit(this.elems[b],this.headX,this.headY-imgSize/4*a,imgSize);return c.open(),this.addChild(c,10-a),c},restart:function(){for(this.removeChild(this.leftArrow),this.removeChild(this.rightArrow),this.removeChild(this.leftSprite),this.removeChild(this.rightSprite),this.removeChild(this.curObj);this.objList.length>0;)this.removeChild(this.objList.shift());this.leftArrow=null,this.rightArrow=null,this.leftSprite=null,this.rightArrow=null,this.curObj=null,this.objList=[],this._init(),this.open()},open:function(){new me.Tween(this).to({alpha:1},200).start()},close:function(){new me.Tween(this).to({alpha:0},200).start()}});game.LoadingScene=me.ScreenObject.extend({onResetEvent:function(){me.game.reset(),me.game.world.addChild(new me.ColorLayer("background","#FFFFFF",0));var a=new ProgressBar(new me.Vector2d,game.data.screenWidth,20);this.handle=me.event.subscribe(me.event.LOADER_PROGRESS,a.onProgressUpdate.bind(a)),me.game.world.addChild(a,1);var b=new me.Sprite(game.data.screenWidth/2-336,game.data.screenHeight/2-177,me.loader.getImage("logo"),672,354);me.game.world.addChild(b,1)},onDestroyEvent:function(){this.handle&&(me.event.unsubscribe(this.handle),this.handle=null)}});var ProgressBar=me.Renderable.extend({init:function(a,b,c){me.Renderable.prototype.init.apply(this,[a.x,a.y,b,c]),this.invalidate=!1,this.barHeight=40,this.progress=0},onProgressUpdate:function(a){this.progress=Math.floor(a*this.width),this.invalidate=!0},update:function(){return this.invalidate===!0?(this.invalidate=!1,!0):!1},draw:function(a){var b=a.getContext();b.fillStyle="black",b.fillRect(0,this.height/2-this.barHeight/2,this.width,this.barHeight),b.fillStyle="#55aa00",b.fillRect(2,this.height/2-this.barHeight/2,this.progress,this.barHeight)}});game.PlayScene=me.ScreenObject.extend({onResetEvent:function(){this.background=new me.ColorLayer("background","#FFFFFF",0),me.game.world.addChild(this.background,0),game.data.score=0,game.data.level=1,game.data.curTime=game.data.totalTime,game.data.startTime=me.timer.getTime(),this.hud=new game.hud.Container,me.game.world.addChild(this.hud),this.round=new Round,me.game.world.addChild(this.round,10),this.round.open()},onDestroyEvent:function(){me.game.world.removeChild(this.hud),me.game.world.removeChild(this.round),this.hud=null,this.round=null}}),game.GameOverScene=me.ScreenObject.extend({init:function(){},onResetEvent:function(){this.background=new me.ColorLayer("background","#FFFFFF",90),me.game.world.addChild(this.background,0),this.hiScore=0;var a=deserializeGameInfo($.cookie("games"));(void 0===a[game.data.gameId]||a[game.data.gameId]<game.data.score)&&(a[game.data.gameId]=game.data.score),$.cookie("games",serializeGameInfo(a),{expires:1,path:"/"}),this.hiScore=a[game.data.gameId],this.calcRank(),this.messages=[],this.messages[0]=new UILabel(game.data.screenWidth/2,game.data.screenHeight/2-256-128,{textAlign:"center",size:48,text:"本次得分"}),this.messages[1]=new UILabel(game.data.screenWidth/2,game.data.screenHeight/2-256-128+48+16,{textAlign:"center",size:128,text:game.data.score||"0"}),this.messages[2]=new UILabel(game.data.screenWidth/2,game.data.screenHeight/2-256-128+48+128+32,{textAlign:"center",size:48,text:"个人最佳："+this.hiScore}),this.messages[3]=new UILabel(game.data.screenWidth/2,game.data.screenHeight/2-256-128+128+96+64,{textAlign:"center",size:48,text:"总分排名："+this.rank+"\n\n超越了全球"+this.rate+"%的用户"}),this.messages.map(function(a){me.game.world.addChild(a,101)}),this.retry=new Retry,me.game.world.addChild(this.retry,100),this.returnToIndex=new ReturnToIndex,me.game.world.addChild(this.returnToIndex,100)},calcRank:function(){if(void 0===game.data.score||0==game.data.score)this.rate=0,this.rank=game.data.totalRank;else if(game.data.score>=game.data.maxScore)this.rate=100,this.rank=1;else{var a=3*game.data.maxScore/7,b=game.data.maxScore/4,c=new Gaussian(a,b*b),d=c.cdf(game.data.score);this.rate=Math.round(100*d),this.rank=Math.round(game.data.totalRank-game.data.totalRank*d)}},onDestroyEvent:function(){this.messages.map(function(a){me.game.world.removeChild(a)}),me.game.world.removeChild(this.retry),me.game.world.removeChild(this.returnToIndex),this.retry=null,this.returnToIndex=null,this.message=[]}});