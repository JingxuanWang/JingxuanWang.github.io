浅谈排行榜的设计
================

Tag: 算法, MySQL

Date: 20130610

### 问题的引出

开发产品时（特别是在游戏中）时常会出现诸如“实时计算用户积分并且显示排名”的需求。
针对这类需求，往往会有多种多样的实现方式，接下来谈谈机种常见的需求和解决方式。

### 这类问题的基本特征

* 纯数字排序
* 数据量较大，一般是百万量级以上
* 因为涉及到线上查询，所以对响应时间的要求较高。(应该维持在<1s的量级)
* 大多不会为了解决这个问题投入过多的资源（极端的反例可以参考搜索引擎）

#### 数据变动的特点及对策

这些东西一般需求方是不会提出来的，如果自己不主动挖掘，往往会在第一时间就错过最好的解决方案。

个人认为数据的变动特点是影响这类问题解决方案最重要的要素。<br>
其分类和解决思路如下：

* 读写都少
	这个其实没有讨论的必要，可以参考下一条的方法。
* 写多读少（或者读写分开在不同时段的情况）
	这种情况通常比较少见。因为很难想象一个排行榜做出来居然读请求比写请求少。
	一个可能的情况是，读写请求分的比较开，或者可以通过某种手段将两类请求错开。
	针对这种情况，一个比较自然的考虑就是——“线下计算，线上查询”。
	这种做法的好处显而易见，如果在一个时间段内读请求少的可以忽略而基本上是写请求的话。
	那么显然应该将计算资源投入在分数和排名的计算而不是为读取做优化上。
	等到更新结束开放读取时，缓存和索引基本已经就绪，即使是大量的数据也可以在短时间内响应。
* 读多写少
	这种情况应该比较常见。（毕竟一个积分榜就应该长成这个样子）
	这种情况的特点是更新和读取掺杂在一起，虽然更新操作远远小于读取操作。
	但是已经达到了会严重改变读取结果的程度因此不能忽略。
	对于这类情况，只能线上实时更新和读取。
	所以必须采取方法进行优化。
* 读写都多
	上一种状况的升级版，说实话比较少见。
	个人更推荐在设计阶段想办法把这种问题转化成前面两类问题，这样可以省不少麻烦。
	当然解决的办法是有，只不过优先考虑成本更低的更容易解决的方式总是好的。


### 典型案例和解决方案

1. 积分排名模式
	AppStore模式。
	每一个玩家有一个积分的属性，根据这个属性排序得到玩家排名。

	SELECT	count(*) + 1 AS rank
	  FROM	user_ranking
	  WHERE	pt > ?

但是很显然的，这个查询会随着用户量的增长而造成极慢的响应时间。

一个很简单的优化方法是使用[覆盖索引](#http://dev.mysql.com/doc/innodb/1.1/en/glossary.html)。
具体到上文的例子里，就是给pt单独一列加上索引执行即可。
对于百万量级的数据排序，使用覆盖索引的查询可以控制平均在300ms左右。
但是对于排名比较靠后，分数比较少的查询而言，最开始的几次查询效率会接近于全表count(*)，响应时间超过1s，实际上不是很理想。
时间代价上虽然说不上很理想，但是配合缓存和对于精度的模糊处理可以应对大部分此类需求。

2, 分段排名模式。

针对第一种积分榜最近常采用的优化方法就是分段排名。
顾名思义就是将用户划分为数段，在段内对用户进行排名。
在需要的情况下组合成各段的总排名。

	SELECT	count(*) + 1 AS rank
	  FROM	user_ranking
	  WHERE pt >= 1000
		AND	pt <  2000
		AND pt > ?

这样做的好处是极大的缩减了需要count(*)的记录条数，缩短响应时间。
坏处是需要额外维护一张表，记录每个区段各有多少用户。
如果用户的跨区间变动比较频繁的花维护的代价会比较大。

并且区间的划分也是一个需要考虑的问题。
一般而言，根据80/20原则，分数比较低的区段需要多划分以平衡每个区段的用户量，比如：

	* >10000pt 每10000pt一段
	* >1000pt  每1000pt一段
	* >100pt   每100pt一段
	* <=100pt  独立一段

当然，实际的分段策略要根据用户的分布而定，需要逐步调整。

可以用MySQL的Partition功能对于这种方法稍作改进，但是无法在时间上取得更好的效果。
在200~300ms的量级，使用partition是可以一定程度改善最坏情况，但是没有办法让查询变得更快

3. 交换排名模式。

交换排名模式仅适用于排名由强弱关系而非具体分数决定的场合。
用户的排名由用户间的胜败关系决定
排名第的用户可以向排名高的用户挑战，如过胜则交换排名。

* 优点
	* 最大限度的减小了排行榜的维护代价
* 缺点
	* 如果更新操作频繁则会产生同步问题
	* 用户很难大范围的提升自己的排名

总体来说是性价比比较高的排名方式。
